<?php
//include('../../facilityDirectoryDatabaseConnectScripts/db_connection.php');
?>

<?php
@define("SERVERNAME", "localhost");
@define("USERNAME", "root");
@define("PASSWORD", "deleted");
@define("DATABASE", "deleted");
	$conn = mysqli_connect(SERVERNAME, USERNAME, PASSWORD, DATABASE);
	//mysql_set_charset('utf8', $conn);
		if (!$conn) {
			die("Uh-oh, the connection failed. That wansn't supposed to happen! Please email: thomas.rowley@baylorhealth.edu and let me know. Thanks!" . mysqli_connect_error());
		}
?>
<?php
 $repeatOnce=[];function conductSearch($queryLookup,$facility,$city,$zipcode,$zipradius){global $conn,$resultCount;$cityLookup="'".trim($city)."'";$zipLookup="'".trim($zipcode)."'";$cityPostArray[]=explode(", ",$city);$cityPostArrayShifted=array_shift($cityPostArray);$citiesArray=[];foreach($cityPostArrayShifted as $value){$trimAndWrapEachCityInQuotes="'".trim($value)."'";array_push($citiesArray,$trimAndWrapEachCityInQuotes);}$citiesLookupString=implode(",",$citiesArray);switch($queryLookup){case '100':$query="SELECT name, numAndStreet, suite, city, zip, phone, url, id FROM facilities WHERE visibility = 1 AND facility = '$facility' ORDER BY city ASC";$result=mysqli_query($conn,$query)or die("<br />Could not execute a case ".$queryLookup." query, see system administrator.");$resultCount=mysqli_num_rows($result);break;case '110':$query="SELECT name, numAndStreet, suite, city, zip, phone, url, id FROM facilities WHERE visibility = 1 AND facility = '$facility' AND city = $cityLookup";$result=mysqli_query($conn,$query)or die("<br />Could not execute a case ".$queryLookup." query, see system administrator.");$resultCount=mysqli_num_rows($result);break;case '101':$query="SELECT * FROM facilities WHERE visibility = 1 AND facility = '$facility' OR zip = $zipLookup ORDER BY facility ASC";$result=mysqli_query($conn,$query)or die("<br />Could not execute a case ".$queryLookup." query, see system administrator.");$resultCount=mysqli_num_rows($result);break;case '010':$query="SELECT * FROM facilities WHERE visibility = 1 AND city = $cityLookup ORDER BY facility ASC";$result=mysqli_query($conn,$query)or die("<br />Could not execute a case ".$queryLookup." query, see system administrator.");$resultCount=mysqli_num_rows($result);break;case '001':$query="SELECT * FROM facilities WHERE visibility = 1 AND zip = $zipLookup ORDER BY facility ASC";$result=mysqli_query($conn,$query)or die("<br />Could not execute a case ".$queryLookup." query, see system administrator.");$resultCount=mysqli_num_rows($result);break;case '111':$query="SELECT * FROM facilities WHERE visibility = 1 AND facility = '$facility' AND city = $cityLookup OR zip = $zipLookup ORDER BY facility ASC";$result=mysqli_query($conn,$query)or die("<br />Could not execute a case ".$queryLookup." query, see system administrator.");$resultCount=mysqli_num_rows($result);break;case '020':$query="SELECT * FROM facilities WHERE visibility = 1 AND city IN ($citiesLookupString) ORDER BY facility ASC, city ASC";$result=mysqli_query($conn,$query)or die("<br />Could not execute a case ".$queryLookup." query, see system administrator.");$resultCount=mysqli_num_rows($result);break;case '120':$query="SELECT * FROM facilities WHERE visibility = 1 AND city IN ($citiesLookupString) AND facility = '$facility' ORDER BY facility ASC, city ASC";$result=mysqli_query($conn,$query)or die("<br />Could not execute a case ".$queryLookup." query, see system administrator.");$resultCount=mysqli_num_rows($result);break;case '011':$query="SELECT * FROM facilities WHERE visibility = 1 AND city = $cityLookup OR zip = $zipLookup ORDER BY facility ASC";$result=mysqli_query($conn,$query)or die("<br />Could not execute a case ".$queryLookup." query, see system administrator.");$resultCount=mysqli_num_rows($result);break;case '122':$getAPIInfo=file_get_contents("http://www.zipcodeapi.com/rest/YrUOJgLcsVAEclLV1TvPaoo6s4haCfiBGdqqubCW7cAkymfzgLoq9MwCRONu365K/radius.json/$zipcode/$zipradius/mile");$zipLookupString=getConvertedZipsforLookup($getAPIInfo);$query="SELECT * FROM facilities WHERE visibility = 1 AND facility = '$facility' AND city IN ($citiesLookupString) OR zip IN ($zipLookupString) ORDER BY facility ASC";$result=mysqli_query($conn,$query)or die("<br />Could not execute a case ".$queryLookup." query, see system administrator.");$resultCount=mysqli_num_rows($result);break;case '022':$getAPIInfo=file_get_contents("http://www.zipcodeapi.com/rest/YrUOJgLcsVAEclLV1TvPaoo6s4haCfiBGdqqubCW7cAkymfzgLoq9MwCRONu365K/radius.json/$zipcode/$zipradius/mile");$zipLookupString=getConvertedZipsforLookup($getAPIInfo);$query="SELECT * FROM facilities WHERE visibility = 1 AND zip IN ($zipLookupString) OR city IN ($citiesLookupString) ORDER BY facility ASC";$result=mysqli_query($conn,$query)or die("<br />Could not execute a case ".$queryLookup." query, see system administrator.");$resultCount=mysqli_num_rows($result);break;case '012':$getAPIInfo=file_get_contents("http://www.zipcodeapi.com/rest/YrUOJgLcsVAEclLV1TvPaoo6s4haCfiBGdqqubCW7cAkymfzgLoq9MwCRONu365K/radius.json/$zipcode/$zipradius/mile");$zipLookupString=getConvertedZipsforLookup($getAPIInfo);$query="SELECT * FROM facilities WHERE visibility = 1 AND zip IN ($zipLookupString) OR city = $cityLookup ORDER BY facility ASC";$result=mysqli_query($conn,$query)or die("<br />Could not execute a case ".$queryLookup." query, see system administrator.");$resultCount=mysqli_num_rows($result);break;case '002':$getAPIInfo=file_get_contents("http://www.zipcodeapi.com/rest/YrUOJgLcsVAEclLV1TvPaoo6s4haCfiBGdqqubCW7cAkymfzgLoq9MwCRONu365K/radius.json/$zipcode/$zipradius/mile");$zipLookupString=getConvertedZipsforLookup($getAPIInfo);$query="SELECT * FROM facilities WHERE visibility = 1 AND zip IN ($zipLookupString) ORDER BY facility ASC";$result=mysqli_query($conn,$query)or die("<br />Could not execute a case ".$queryLookup." query, see system administrator.");$resultCount=mysqli_num_rows($result);break;case '112':$getAPIInfo=file_get_contents("http://www.zipcodeapi.com/rest/YrUOJgLcsVAEclLV1TvPaoo6s4haCfiBGdqqubCW7cAkymfzgLoq9MwCRONu365K/radius.json/$zipcode/$zipradius/mile");$zipLookupString=getConvertedZipsforLookup($getAPIInfo);$query="SELECT * FROM facilities WHERE visibility = 1 AND facility = '$facility' AND city IN ($citiesLookupString) OR zip IN ($zipLookupString) ORDER BY facility ASC";$result=mysqli_query($conn,$query)or die("<br />Could not execute a case ".$queryLookup." query, see system administrator.");$resultCount=mysqli_num_rows($result);break;case '121':$getAPIInfo=file_get_contents("http://www.zipcodeapi.com/rest/YrUOJgLcsVAEclLV1TvPaoo6s4haCfiBGdqqubCW7cAkymfzgLoq9MwCRONu365K/radius.json/$zipcode/$zipradius/mile");$zipLookupString=getConvertedZipsforLookup($getAPIInfo);$query="SELECT * FROM facilities WHERE visibility = 1 AND facility = '$facility' AND city IN ($citiesLookupString) OR zip = $zipLookup ORDER BY facility ASC";$result=mysqli_query($conn,$query)or die("<br />Could not execute a case ".$queryLookup." query, see system administrator.");$resultCount=mysqli_num_rows($result);break;case '021':$query="SELECT * FROM facilities WHERE visibility = 1 AND city IN ($citiesLookupString) OR zip = $zipLookup ORDER BY facility ASC";$result=mysqli_query($conn,$query)or die("<br />Could not execute a case ".$queryLookup." query, see system administrator.");$resultCount=mysqli_num_rows($result);break;case '102':$getAPIInfo=file_get_contents("http://www.zipcodeapi.com/rest/YrUOJgLcsVAEclLV1TvPaoo6s4haCfiBGdqqubCW7cAkymfzgLoq9MwCRONu365K/radius.json/$zipcode/$zipradius/mile");$zipLookupString=getConvertedZipsforLookup($getAPIInfo);$query="SELECT * FROM facilities WHERE visibility = 1 AND zip IN ($zipLookupString) OR facility = '$facility' ORDER BY facility ASC";$result=mysqli_query($conn,$query)or die("<br />Could not execute a case ".$queryLookup." query, see system administrator.");$resultCount=mysqli_num_rows($result);break;}displayRowCount($resultCount);displaySearchResults($result);}function getConvertedZipsforLookup($getAPIInfo){$convertedJSONData=[];$convertToPHPArray=json_decode($getAPIInfo,TRUE);foreach($convertToPHPArray as $row){foreach($row as $pulledZip){array_push($convertedJSONData,$pulledZip['zip_code']);}}$zipsArray=[];foreach($convertedJSONData as $value){$trimAndWrapEachZipInQuotes="'".trim($value)."'";array_push($zipsArray,$trimAndWrapEachZipInQuotes);}$zipLookupString=implode(",",$zipsArray);return $zipLookupString;}function displayRowCount($rows){echo"<h1>Produced the following {$rows} results:</h1>";}function displayFacility($addFacility){global $repeatOnce;if(!in_array($addFacility,$repeatOnce)){array_push($repeatOnce,$addFacility);return $addFacility;}}function displaySearchResults($result){$counter=1;while($row=mysqli_fetch_array($result)){extract($row);$myFacilityType=(isset($facility))?$myFacilityType=$facility:$myFacilityType="";$myName=$name;$myNumAndStreet=$numAndStreet;$mySuite=$suite;$myCity=$city;$myZip=$zip;$myPhone=$phone;$myURL=$url;$counter++;$rowColor=($counter&1)?$rowColor='resultDCDCDC':$rowColor='resultC8DAE8';$matches=NULL;$getAddressForGoogleMaps=preg_match('/^\d*/',$myNumAndStreet,$matches);echo "<hr class=\"searchRule\" />
<h3 class=\"facilityType\">".displayFacility($myFacilityType)."</h3>
<div class={$rowColor}>
<ul class=\"resultList\">
	<li class=\"facilityName\">{$myName}</li>
	<li><a href=\"http://maps.google.com/maps?q={$myNumAndStreet}+{$myCity}+TX+{$myZip}\" target=\"self\">{$myNumAndStreet} {$mySuite}<br />
	{$myCity}, TX {$myZip}</a></li>
	<li class=\"phone\"> <a href=tel:{$myPhone}>{$myPhone}</a></li>
	<li class=\"url\"><a href=\"http://{$myURL}\" target=\"self\">{$myURL}</a></li>
</ul>
</div>";}if(isset($repeatOnce,$getAPIInfo,$cityPostArray,$citiesArray)){unset($repeatOnce,$getAPIInfo,$cityPostArray,$citiesArray);}mysqli_free_result($result);if(isset($conn)){mysqli_close($conn);};}?>
